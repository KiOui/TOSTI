{% load static %}
<link rel="stylesheet" href="{% static 'thaliedje/css/player.css' %}"/>
<div class="player" id="player-container-{{ player.id }}">
<template v-if="player_data.track !== null">
    <div class="w-50 mx-auto mb-2">
        <a href="{% url "thaliedje:now_playing" venue=player.venue %}">
            <img class="w-100" :src="player_data.track.image"/>
        </a>
    </div>
    <div class="text-center m-auto"><% player_data.track.name %></div>
    <div class="text-center w-100">
        <template v-for="(artist, index) in player_data.track.artists">
            <template v-if="index === player_data.track.artists.length - 1">
                <% artist %>
            </template>
            <template v-else>
                <% artist %> -
            </template>
        </template>
    </div>
</template>
<template v-else>
    <div class="text-center m-auto">No currently playing track</div>
</template>
{% if controls %}
    <div class="player-controls mt-3 mb-3">
        <i class="fas fa-backward" v-on:click="backward()"></i>
        <template v-if="player_data.is_playing">
            <i class="fas fa-pause" v-on:click="pause()"></i>
        </template>
        <template v-else>
            <i class="fas fa-play" v-on:click="play()"></i>
        </template>
        <i class="fas fa-forward" v-on:click="forward()"></i>
    </div>
{% endif %}
</div>
<script>
    let player_{{ player.id }}_vue = new Vue({
        el: '#player-container-{{ player.id }}',
        delimiters: ['<%', '%>'],
        data: {
            player_data: {
                is_playing: false,
                track: null,
            }
        },
        created() {
            fetch('{% url "v1:player_retrieve" pk=player.id %}')
            .then(response => response.json())
            .then(json => {
                this.player_data = json;
            });
        },
        methods: {
            play() {
                fetch(
                    '{% url "v1:player_play" player=player %}',
                    {
                        method: "PATCH",
                        headers: {
                            "X-CSRFToken": get_csrf_token(),
                            "Accept": 'application/json',
                        }
                    }
                ).then(response => {
                    if (response.status === 200) {
                        return response;
                    } else {
                        throw response;
                    }
                }).then(() => {
                    if (typeof (update_refresh_list) !== 'undefined') {
                        update_refresh_list();
                    }
                }).catch(error => {
                    if (error.status && error.status !== 403) {
                        toastr.error("Failed to communicate with the Spotify device, make sure the device is available.");
                    } else {
                        show_error_from_api(error);
                    }
                });
            },
            pause() {
                fetch(
                    '{% url "v1:player_pause" player=player %}',
                    {
                        method: "PATCH",
                        headers: {
                            "X-CSRFToken": get_csrf_token(),
                            "Accept": 'application/json',
                        }
                    }
                ).then(response => {
                    if (response.status === 200) {
                        return response;
                    } else {
                        throw response;
                    }
                }).then(() => {
                    if (typeof (update_refresh_list) !== 'undefined') {
                        update_refresh_list();
                    }
                }).catch(error => {
                    if (error.status && error.status !== 403) {
                        toastr.error("Failed to communicate with the Spotify device, make sure the device is available.");
                    } else {
                        show_error_from_api(error);
                    }
                });
            },
            forward() {
                fetch(
                    '{% url "v1:player_next" player=player %}',
                    {
                        method: "PATCH",
                        headers: {
                            "X-CSRFToken": get_csrf_token(),
                            "Accept": 'application/json',
                        }
                    }
                ).then(response => {
                    if (response.status === 200) {
                        return response;
                    } else {
                        throw response;
                    }
                }).then(() => {
                    if (typeof (update_refresh_list) !== 'undefined') {
                        update_refresh_list();
                    }
                }).catch(error => {
                    if (error.status && error.status !== 403) {
                        toastr.error("Failed to communicate with the Spotify device, make sure the device is available.");
                    } else {
                        show_error_from_api(error);
                    }
                });
            },
            backward() {
                fetch(
                    '{% url "v1:player_previous" player=player %}',
                    {
                        method: "PATCH",
                        headers: {
                            "X-CSRFToken": get_csrf_token(),
                            "Accept": 'application/json',
                        }
                    }
                ).then(response => {
                    if (response.status === 200) {
                        return response;
                    } else {
                        throw response;
                    }
                }).then(() => {
                    if (typeof (update_refresh_list) !== 'undefined') {
                        update_refresh_list();
                    }
                }).catch(error => {
                    if (error.status && error.status !== 403) {
                        toastr.error("Failed to communicate with the Spotify device, make sure the device is available.");
                    } else {
                        show_error_from_api(error);
                    }
                });
            }
        }
    });
    add_refresh_url("{% url "v1:player_retrieve" pk=player.id %}", function(data) {player_{{ player.id }}_vue.player_data = data});
</script>