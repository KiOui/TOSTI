{% extends 'tosti/base.html' %}
{% load static order_now %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'orders/css/order-list.css' %}"/>
    <link rel="stylesheet" href="{% static 'orders/css/item-list.css' %}"/>
{% endblock %}

{% block page %}
    {% include 'orders/shift_header.html' with shift=shift %}
    <div class="container mb-5">
        <div class="row" id="page-sidebar-container">
            <div class="col-md">
                <div class="container-sm mb-5 text-center order-vue-container" id="product-list">
                    <p>Order your items below</p>
                    <div id="product-list">
                        <div v-if="loading" class="position-absolute w-100 h-100"></div>
                        <ul v-if="restricted_products.length > 0" class="order-list">
                            <li v-for="product in restricted_products" class="order-item pt-2 pb-2 mt-2 mb-2">
                                <i v-if="product.icon" :class="`fas fa-${product.icon}`"></i>
                                <p class="order-name"><% product.name %></p>
                                <p class="item-price">€<% (Math.round(product.current_price * 100) / 100).toFixed(2) %></p>
                                <div v-if="product.max_allowed !== null && get_amount_of_item_orders(product.id) >= product.max_allowed"
                                     class="item-overlay">
                                    <div class="overlay"></div>
                                    <p class="alert alert-warning">You have ordered the maximum of this item.</p>
                                </div>
                                <input class="btn btn-success ms-2" type="button" value="Add"
                                       v-on:click="add_product(product);"/>
                            </li>
                            <li v-if="shift.max_user_orders !== null && amount_of_restricted_cart_items >= shift.max_user_orders"
                                class="item-overlay">
                                <div class="overlay"></div>
                                <p class="alert alert-warning">You have ordered the maximum amount of orders you can place this
                                    shift.</p>
                            </li>
                        </ul>
                        <ul v-if="unrestricted_products.length > 0" class="order-list">
                            <li v-for="product in unrestricted_products" class="order-item pt-2 pb-2 mt-2 mb-2">
                                <i v-if="product.icon" :class="`fas fa-${product.icon}`"></i>
                                <p class="order-name"><% product.name %></p>
                                <p class="item-price">€<% (Math.round(product.current_price * 100) / 100).toFixed(2) %></p>
                                <input class="btn btn-success ms-2" type="button" value="Add"
                                       v-on:click="add_product(product);"/>
                            </li>
                        </ul>
                        <p v-if="unrestricted_products.length === 0 && restricted_products.length === 0" class="alert alert-warning">There are no products you can order.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="container-sm text-center pb-5 order-vue-container" id="cart-list">
                    <h2>Ordered items</h2>
                    <p>Manage the items in your cart</p>
                    <div id="order-list">
                        <ul v-if="cart.length > 0" class="order-list">
                            <li v-for="item in cart" class="order-item">
                                <i v-if="item.icon" :class="`fas fa-${item.icon}`"></i>
                                <p class="order-name"><% item.name %></p>
                                <input class="btn btn-danger ms-2" type="button" value="Remove"
                                       v-on:click="delete_product(item);"/>
                            </li>
                        </ul>
                        <p v-else class='alert alert-warning'>There are no items in your cart.</p>
                    </div>
                    <div v-show="cart.length > 0" class="btn-on btn-ml" id="order-button"
                         v-on:click="submit_cart()">
                        Place order
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container mb-5">
        <a href="{% url "orders:shift_overview" shift=shift %}">
            <div class="btn-ml btn-on">
                <h5><i class="fas fa-arrow-left"></i> Back to overview</h5>
            </div>
        </a>
    </div>
{% endblock %}

{% block js %}
    <script>
        let order_vue = new Vue({
            el: '#page-sidebar-container',
            delimiters: ['<%', '%>'],
            data: {
                cart: [],
                restricted_products: [],
                unrestricted_products: [],
                shift: {},
                loading: true,
                placing_order: false,
            },
            created() {
                const product_unrestricted_list_fetch = fetch('{% url "v1:product_list" shift=shift %}?orderable=True&available=True&ignore_shift_restrictions=True')
                    .then(response => response.json())
                    .then(json => {
                        this.unrestricted_products = json;
                    });
                const product_restricted_list_fetch = fetch('{% url "v1:product_list" shift=shift %}?orderable=True&available=True&ignore_shift_restrictions=False')
                    .then(response => response.json())
                    .then(json => {
                        this.restricted_products = json;
                    });
                const shift_fetch = fetch('{% url "v1:shift_retrieveupdate" pk=shift.id %}')
                    .then(response => response.json())
                    .then(json => {
                        this.shift = json;
                    });
                Promise.all([product_unrestricted_list_fetch, product_restricted_list_fetch, shift_fetch]).then(_ => {
                    this.loading = false;
                })
            },
            computed: {
                amount_of_restricted_cart_items() {
                    return this.cart.filter(value => {
                        return !value.ignore_shift_restrictions;
                    }).length;
                }
            },
            methods: {
                get_amount_of_item_orders(product_id) {
                    return this.cart.filter(value => {
                        return value.id === product_id;
                    }).length;
                },
                add_product(product) {
                    if (this.amount_of_restricted_cart_items < this.shift.max_user_orders || product.ignore_shift_restrictions) {
                        this.cart.push(product);
                        return true;
                    }
                },
                delete_product(product) {
                    for (let i = 0; i < this.cart.length; i++) {
                        if (this.cart[i].id === product.id) {
                            this.cart.splice(i, 1);
                            return;
                        }
                    }
                },
                submit_cart() {
                    if (!this.placing_order) {
                        this.placing_order = true;

                    }
                }
            }
        });
    </script>
{% endblock %}