{% extends 'tosti/sidebar.html' %}
{% load static order_now %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'orders/css/order-list.css' %}"/>
    <link rel="stylesheet" href="{% static 'orders/css/item-list.css' %}"/>
{% endblock %}

{% block content %}
    {% include 'orders/shift_header.html' with shift=shift %}
    <div class="container-sm mb-5 text-center" id="product-list">
        <p>Order your items below</p>
        <div id="product-list">
            <ul v-if="get_restricted_products(products).length > 0" class="order-list">
                <li v-for="product in get_restricted_products(products)" class="order-item pt-2 pb-2 mt-2 mb-2">
                    <i v-if="product.icon" :class="`fas fa-${product.icon}`"></i>
                    <p class="order-name"><% product.name %></p>
                    <p class="item-price">€<% (Math.round(product.current_price * 100) / 100).toFixed(2) %></p>
                    <div v-if="product.max_allowed !== null && get_amount_of_item_orders(product.id) >= product.max_allowed"
                         class="item-overlay">
                        <p class="alert alert-warning">You have ordered the maximum of this item.</p>
                    </div>
                    <input class="btn btn-success ms-2" type="button" value="Add"
                           :onclick="`add_product(${product.id});`"/>
                </li>
                <li v-if="shift.max_user_orders !== null && get_amount_of_restricted_cart_items() >= shift.max_user_orders"
                    class="item-overlay">
                    <p class="alert alert-warning">You have ordered the maximum amount of orders you can place this
                        shift.</p>
                </li>
            </ul>
            <ul v-if="get_unrestricted_products(products).length > 0" class="order-list">
                <li v-for="product in get_unrestricted_products(products)" class="order-item pt-2 pb-2 mt-2 mb-2">
                    <i v-if="product.icon" :class="`fas fa-${product.icon}`"></i>
                    <p class="order-name"><% product.name %></p>
                    <p class="item-price">€<% (Math.round(product.current_price * 100) / 100).toFixed(2) %></p>
                    <input class="btn btn-success ms-2" type="button" value="Add"
                           :onclick="`add_product(${product.id});`"/>
                </li>
            </ul>
            <p v-if="products.length === 0" class="alert alert-warning">There are no products you can order.</p>
        </div>
    </div>
{% endblock %}

{% block sidebar %}
    <div class="container-sm text-center pb-5" id="cart-list">
        <h2>Selected items</h2>
        <p>Manage the items in your cart</p>
        <div id="order-list">
            <ul v-if="cart.length > 0" class="order-list">
                <li v-for="item in cart" class="order-item">
                    <i v-if="item.icon" :class="`fas fa-${item.icon}`"></i>
                    <p class="order-name"><% item.name %></p>
                    <input class="btn btn-danger ms-2" type="button" value="Remove"
                           :onclick="`delete_product(${item.id});`"/>
                </li>
            </ul>
            <p v-else class='alert alert-warning'>There are no items in your cart.</p>
        </div>
        <div v-show="cart.length > 0" class="btn-on btn-ml" id="order-button"
             v-on:click="submit_cart()">
            Place order
        </div>
    </div>
{% endblock %}

{% block page-footer %}
    <a href="{% url "orders:shift_overview" shift=shift %}">
        <div class="btn-ml btn-on">
            <h5><i class="fas fa-arrow-left"></i> Back to overview</h5>
        </div>
    </a>
{% endblock %}

{% block js %}
    <script>
        const CART_COOKIE_NAME = "cart_{{ shift.id }}";
    </script>
    <script src="{% static 'orders/js/asynch-order-orders.js' %}"></script>
    <script>
        let product_list_vue = new Vue({
            el: '#product-list',
            delimiters: ['<%', '%>'],
            data: {
                products: [],
                shift: {}
            },
            created() {
                fetch('{% url "v1:product_list" shift=shift %}')
                    .then(response => response.json())
                    .then(json => {
                        json = json.filter(product => product.orderable);
                        this.products = json;
                    });
                fetch('{% url "v1:shift_retrieveupdate" pk=shift.id %}')
                    .then(response => response.json())
                    .then(json => {
                        this.shift = json;
                    });
            }
        });
        let cart_list_vue = new Vue({
            el: '#cart-list',
            delimiters: ['<%', '%>'],
            data: {
                cart: [],
                loading: false,
            },
            created() {
                fetch('{% url "v1:product_list" shift=shift %}')
                    .then(response => response.json())
                    .then(json => {
                        json = json.filter(product => product.orderable);
                        this.products = json;
                    });
                this.cart = get_cart_list();
            },
            methods: {
                submit_cart() {
                    this.loading = true;
                    fetch(
                        '{% url "v1:shifts_cart_order" shift=shift %}',
                        {
                            method: "POST",
                            body: JSON.stringify({cart: this.cart.map(product => product.id)}),
                            headers: {
                                "X-CSRFToken": get_csrf_token(),
                                "Accept": 'application/json',
                                "Content-Type": 'application/json',
                            }
                        }
                    ).then(response => {
                        if (response.status === 200) {
                            return response;
                        } else {
                            throw response;
                        }
                    }).then(() => {
                        this.cart = [];
                        set_cart_list([]);
                        if (typeof (update_refresh_list) !== 'undefined') {
                            update_refresh_list();
                        }
                        tata.success("", "Your order has been placed!", "Order notification");
                        setTimeout(function() {window.location.reload()}, 1000);
                    }).catch(error => {
                        console.log(error);
                        show_error_from_api(error);
                    }).finally(() => {
                        this.loading = false;
                    });
                }
            }
        });
    </script>
{% endblock %}