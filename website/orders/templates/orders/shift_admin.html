{% extends 'tosti/base.html' %}
{% load static order_now %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'orders/css/forms.css' %}"/>
    <link rel="stylesheet" href="{% static 'tosti/css/index.css' %}"/>
    <link rel="stylesheet" href="{% static 'orders/css/item-list.css' %}"/>
    <link rel="stylesheet" href="{% static 'orders/css/admin-footer.css' %}"/>
    <link rel="stylesheet" href="{% static 'orders/css/scanner.css' %}"/>
    <link rel="stylesheet" href="{% static 'orders/css/search.css' %}"/>
{% endblock %}

{% block page %}
    <div class="container-sm mb-2 text-center" id="header-container-{{ shift.id }}">
        <h1>{{ shift.venue.venue.name }}</h1>
        <p class="my-4 mx-auto" style="font-size: 1rem; max-width: 400px;">
            shift #{{ shift.pk }} - <% shift.amount_of_orders %>/<% shift.max_orders_total %> - <% shift.start_date %> until <% shift.end_date %><br>
            <template v-if="shift.assignees && shift.assignees.length > 0">
                At your service:
                <template v-for="(assignee, index) in shift.assignees">
                    <% assignee %>
                    <template v-if="index !== shift.assignees.length-1">, </template>
                </template>
            </template>
            <template v-else>
                No assignees
            </template>
        </p>
        <p v-if="!shift.can_order" class="alert alert-danger"><i class="far fa-hand-paper"></i><br>This shift does not accept orders at this moment.</p>
    </div>

    <div class="container">
        <div class="btn-ml btn-on" data-toggle="modal" data-target="#scanner-popup"><i class="fas fa-barcode"></i> Barcode scanner</div>
    </div>

    <div class="modal" id="scanner-popup">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Barcode scanner</h2>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="container">
                        <div class="search-container">
                            <label>
                                <input v-model="search_input" type="text" placeholder="Search for a product" id="product-search"/>
                            </label>
                            <template v-if="search_input !== ''">
                                <div v-if="search_results.length > 0" id="search-results">
                                    <div v-for="product in search_results" class="search-item">
                                        <p class="search-item-name"><% product.name %></p>
                                        <div class="flex-divider"></div>
                                        <p class="search-item-price">€<% product.current_price %></p>
                                        <input type="button" class="btn btn-success" :onclick="`post_and_callback_with_error('{% url "v1:orders_create" shift=shift %}', {'product': ${product.id}, 'type': 1, 'user': null, 'paid': true, 'ready': true}, order_added, order_added_error)`" value="Add"/>
                                    </div>
                                </div>
                                <div v-else id="search-results">
                                    <div class="search-item">
                                        <p class="search-item-name">No products found</p>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    <div class="container scanner-container">
                        <div id="scanner">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <p id="message-success" class="alert alert-success" v-show="message !== null"><% message %></p>
    </div>
    <div class="container-sm">
        <div class="container">
            <hr>
        </div>
        <div id="item-orders">
            <!-- Order modal popup -->
            <div class="modal" id="order-overview-popup">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 class="modal-title">Shift summary</h2>
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                        </div>
                        <div class="modal-body" id="order-overview-popup-list-{{ shift.id }}">
                            <h3>Orders to make</h3>
                            <template v-if="Object.keys(orders_to_make).length > 0">
                                <p v-for="(product_dict, product_name) in orders_to_make" class="mb-2" style="font-size: 1em;"><% product_dict.product.name %> <i :class="`fas fa-${product_dict.product.icon}`"></i> &times; <% product_dict.amount %></p>
                            </template>
                            <template v-else>
                                <p class="mb-2" style="font-size: 1em;">No open products.</p>
                            </template>
                            <div class="dropdown-divider"></div>
                            <h3 class="mt-3">Orders made</h3>
                            <template v-if="Object.keys(orders_made).length > 0">
                                <p v-for="(product_dict, product_name) in orders_made" class="mb-2" style="font-size: 1em;"><% product_dict.product.name %> <i :class="`fas fa-${product_dict.product.icon}`"></i> &times; <% product_dict.amount %></p>
                            </template>
                            <template v-else>
                                <p class="mb-2" style="font-size: 1em;">No ready products.</p>
                            </template>
                            <div class="dropdown-divider"></div>
                            <h3 class="mt-3">Orders total</h3>
                            <template v-if="Object.keys(orders_total).length > 0">
                                <p v-for="(product_dict, product_name) in orders_total" class="mb-2" style="font-size: 1em;"><% product_dict.product.name %> <i :class="`fas fa-${product_dict.product.icon}`"></i> &times; <% product_dict.amount %></p>
                            </template>
                            <template v-else>
                                <p class="mb-2" style="font-size: 1em;">No products.</p>
                            </template>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Item orders -->
            <ul v-if="orders.length > 0" class="item-orders">
                <template v-for="(order, index) in orders">
                    <li class="pt-2 pb-2 item-list">
                        <div class="information-row">
                            <p class="item-counter"><% index + 1 %>.</p>
                            <p class="item-name"><% order.product.name %> (€<% order.order_price %>)</p>
                            <i v-if="order.product.icon !== null" :class="`fas fa-${order.product.icon} item-icon`"></i>
                            <div class="flex-divider"></div>
                            <i v-if="order.user !== null && user_id === order.user.id" class="fas fa-user user-icon"></i>
                            <p v-if="order.user !== null" class="item-username"><% order.user.username %></p>
                            <i v-else class="item-username fas fa-desktop"></i>
                        </div>
                        <div class="button-row">
                            <template v-if="order.type === 0">
                                <input v-if="order.paid" type="button" class="checkbox-paid btn mr-2 btn-success" :onclick="`patch('/api/v1/shifts/${shift.id}/orders/${order.id}', {'paid': false}, function(data) {update_update_list()});`" value="Paid"/>
                                <input v-else type="button" class="checkbox-paid btn mr-2 btn-danger" :onclick="`patch('/api/v1/shifts/${shift.id}/orders/${order.id}', {'paid': true}, function(data) {update_update_list()});`" value="Paid"/>
                                <input v-if="order.ready" type="button" class="checkbox-ready btn btn-success" :onclick="`patch('/api/v1/shifts/${shift.id}/orders/${order.id}', {'ready': false}, function(data) {update_update_list()});`" value="Ready"/>
                                <input v-else type="button" class="checkbox-ready btn btn-danger" :onclick="`patch('/api/v1/shifts/${shift.id}/orders/${order.id}', {'ready': true}, function(data) {update_update_list()});`" value="Ready"/>
                            </template>
                            <template v-else>
                                <input type="button" class="btn btn-danger" :onclick="`if (window.confirm('Do you want to delete this order?')) { delete_and_callback('/api/v1/shifts/${shift.id}/orders/${order.id}', {}, update_update_list)}`" value="Remove"/>
                            </template>
                        </div>
                    </li>
                </template>
            </ul>
            <div v-else id="outer" class="container d-flex align-items-center justify-content-center text-center" style="height:200px;">
                <div id="inner">
                    No orders yet...
                </div>
            </div>
        </div>
    </div>
    <div class="container pt-5 pb-5"></div>
{% endblock %}

{% block footer %}
    <footer class="page-footer navbar navbar-expand-md fixed-bottom" id="footer-container">
        <div class="container text-center">
            <div class="row flex-grow-1 navbar-collapse collapse" id="footer-menu">
                <div class="col expand-mobile">
                    <div v-if="shift.can_order" :id="`shift-status-${shift.id}`" class="h-100 btn-ml m-auto cursor-pointer bg-success" onclick="patch('{% url "v1:shift_retrieveupdate" pk=shift.pk %}', {'can_order': false}, function(data) {vue.shift = data;});">
                        <p class="font-footer flex-fixed"><i class="far fa-hand-paper"></i></p>
                        <p class="font-footer">Allow/disallow</p>
                    </div>
                    <div v-else :id="`shift-status-${shift.id}`" class="h-100 btn-ml m-auto cursor-pointer bg-danger" onclick="patch('{% url "v1:shift_retrieveupdate" pk=shift.pk %}', {'can_order': true}, function(data) {vue.shift = data;});">
                        <p class="font-footer flex-fixed"><i class="far fa-hand-paper"></i></p>
                        <p class="font-footer">Allow/disallow</p>
                    </div>
                </div>
                <div class="col expand-mobile">
                    <div class="h-100 btn-ml btn-on m-auto" onclick="post_and_callback('{% url "v1:shifts_add_time" shift=shift %}', {}, function(data) {vue.shift = data; vue.message = 'Added 5 minutes to the end time of this shift';});">
                        <p class="font-footer flex-fixed"><i class="far fa-clock"></i> + 5</p>
                        <p class="font-footer">Extend time</p>
                    </div>
                </div>
                <div class="col expand-mobile">
                    <div class="h-100 btn-ml btn-on m-auto" onclick="post_and_callback('{% url "v1:shifts_add_capacity" shift=shift %}', {}, function(data) {vue.shift = data; vue.message = 'Added 5 capacity to this shift';});">
                        <p class="font-footer flex-fixed"><i class="fas fa-list"></i> + 5</p>
                        <p class="font-footer">Add orders</p>
                    </div>
                </div>
                <div class="col expand-mobile">
                    <a href="{% url "orders:shift_overview" shift=shift %}">
                        <div class="h-100 btn-ml btn-on m-auto w-100">
                            <p class="font-footer flex-fixed"><i class="fas fa-users"></i></p>
                            <p class="font-footer">Order page</p>
                        </div>
                    </a>
                </div>
                {% if request.user.is_staff and has_change_order_permissions %}
                <div class="col expand-mobile">
                    <a href="{% url "admin:orders_shift_change" shift.id %}">
                        <div class="h-100 btn-ml btn-on m-auto w-100">
                            <p class="font-footer flex-fixed"><i class="fas fa-cog"></i></p>
                            <p class="font-footer">Settings</p>
                        </div>
                    </a>
                </div>
                <div class="col expand-mobile">
                    <div class="h-100 btn-ml btn-on m-auto w-100" id="overview-button" data-toggle="modal" data-target="#order-overview-popup">
                        <p class="font-footer flex-fixed"><i class="fas fa-binoculars"></i></p>
                        <p class="font-footer">Summary</p>
                    </div>
                </div>
                {% endif %}
            </div>
            <button id="footer-toggler" class="navbar-toggler m-auto" style="border: 0" type="button" data-toggle="collapse" data-target="#footer-menu">
                <i class="fas fa-caret-up text-white"></i>
            </button>
        </div>
    </footer>
{% endblock %}

{% block js %}
    <script>
        const SCANNER_DATA_URL = "{% url 'v1:shifts_scanner' shift=shift %}";
        const POPUP_MODAL = "#scanner-popup";
        const SEARCH_URL = "{% url 'v1:product_search' shift=shift %}";
    </script>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script src="{% static "orders/js/quagga.min.js" %}"></script>
    <script src="{% static "orders/js/admin-scanner.js" %}"></script>
    <script src="{% static "orders/js/search.js" %}"></script>
    <script>
        let user_id = {{ user.id }};
        let vue = new Vue({
            el: '#page-container',
            delimiters: ['<%', '%>'],
            data: {
                orders: [],
                shift: {},
                message: null,
                search_results: [],
                search_input: ""
            },
            computed: {
                orders_to_make: function() {
                    let orders_to_make = {};
                    this.orders.filter(order => !order.ready).forEach(order => {
                        if (order.product.name in orders_to_make) {
                            orders_to_make[order.product.name].amount += 1;
                        }
                        else {
                            orders_to_make[order.product.name] = {"product": order.product, "amount": 1};
                        }
                    });
                    return orders_to_make;
                },
                orders_made: function() {
                    let orders_made = {};
                    this.orders.filter(order => order.ready).forEach(order => {
                        if (order.product.name in orders_made) {
                            orders_made[order.product.name].amount += 1;
                        }
                        else {
                            orders_made[order.product.name] = {"product": order.product, "amount": 1};
                        }
                    });
                    return orders_made;
                },
                orders_total: function() {
                    let orders_total = {};
                    this.orders.forEach(order => {
                        if (order.product.name in orders_total) {
                            orders_total[order.product.name].amount += 1;
                        }
                        else {
                            orders_total[order.product.name] = {"product": order.product, "amount": 1};
                        }
                    });
                    return orders_total;
                }
            },
            watch: {
                search_input: {
                    handler(val, oldVal) {
                        set_search_timeout();
                    }
                }
            },
            created() {
                fetch('{% url "v1:orders_list" shift=shift %}')
                    .then(response => response.json())
                    .then(json => {
                        this.orders = json;
                    });
                fetch('{% url "v1:shift_retrieveupdate" pk=shift.id %}')
                    .then(response => response.json())
                    .then(json => {
                        this.shift = json;
                    });
            },
            mounted() {
                //call function on modal shown
                $(POPUP_MODAL).on('shown.bs.modal', function () {
                    start_scanner();
                });

                //call function on hiding modal
                $(POPUP_MODAL).on('hidden.bs.modal', function () {
                    stop_scanner();
                });
            }
        });
        add_update_list(get_and_callback, ["{% url "v1:orders_list" shift=shift %}", {}, function(data) {vue.orders = data}]);
        add_update_list(get_and_callback, ["{% url "v1:shift_retrieveupdate" pk=shift.id %}", {}, function(data) {vue.shift = data}]);
    </script>
{% endblock %}